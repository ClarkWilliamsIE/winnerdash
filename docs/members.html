<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Winnerland Members</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    body { margin:0; padding:0; background:#121212; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; position:sticky; top:0; backdrop-filter: blur(6px); background:rgba(18,18,18,.85); border-bottom:1px solid #222; z-index:10; }
    header .left { display:flex; align-items:center; gap:10px; }
    header h1 { font-size:1.15rem; margin:0; }
    header .right { display:flex; align-items:center; gap:10px; }
    .btn { padding:.55rem .8rem; border-radius:10px; border:1px solid #333; background:#1e1e1e; color:#fff; cursor:pointer; }
    .btn:hover { background:#252525; }
    .accent { border-color:#3b82f6; }
    .danger { border-color:#ef4444; }
    .tag { font-size:.85rem; color:#bdbdbd; }
    main { padding:16px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; margin-bottom:.75rem; }
    .toolbar input, .toolbar select { background:#0f0f0f; color:#fff; border:1px solid #333; border-radius:10px; padding:.5rem .65rem; }
    .dashboard { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; margin-top:.75rem; }
    .chart-card { background:#1e1e1e; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.25); padding:1rem; display:flex; flex-direction:column; border: 3px solid transparent; }
    .chart-card h2 { margin:0 0 .5rem; font-size:1.05rem; text-align:center; color:#fff; }
    .chart-container { position:relative; flex:1; height: 220px; }
    .chart-container canvas { width:100% !important; height:100% !important; }
    .footnote { color:#9aa0a6; font-size:.85rem; text-align:center; margin-top:.75rem; }
    .row { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1>Winnerland Members</h1>
      <span class="tag" id="userTag"></span>
    </div>
    <div class="right">
      <button class="btn" onclick="location.href='watchlist.html'">Watchlist voting</button>
      <button class="btn" id="btnExportPNGs">Export charts as PNG</button>
      <button class="btn accent" id="btnRefresh">Refresh</button>
      <button class="btn danger" id="btnSignOut">Sign out</button>
    </div>
  </header>

  <main>
    <div class="toolbar">
      <label class="row">
        <span>Member count</span>
        <input id="memberCount" type="number" min="1" value="1" />
      </label>
      <label class="row">
        <span>Filter ticker</span>
        <input id="filterTicker" type="text" placeholder="For example AAPL" />
      </label>
      <label class="row">
        <span>Hide NZD below</span>
        <input id="minNZD" type="number" min="0" step="1" value="0" />
      </label>
      <label class="row">
        <span>Show percent line</span>
        <select id="pctMode">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </label>
    </div>

    <div class="dashboard" id="dashboard"></div>
    <p class="footnote">Your charts are private to your account. Change the member count to show per person values.</p>
  </main>

  <script src="app.js"></script>
  <script>
    const SUPABASE_URL = "https://acdlgvcxzxjvcwiqlydj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZGxndmN4enhqdmN3aXFseWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2Mjc5NzksImV4cCI6MjA3MjIwMzk3OX0.9ZUURjJT73Igd2tAOv8aSZUmlkEf7DIzmOAGBSjWqCI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function guard() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { location.href = "login.html"; return; }
      const { data: { user } } = await supabase.auth.getUser();
      document.getElementById("userTag").textContent = user && user.email ? "(" + user.email + ")" : "";
    }

    guard();

    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) location.href = "login.html";
    });

    document.getElementById("btnSignOut").addEventListener("click", async () => {
      await supabase.auth.signOut();
      location.href = "login.html";
    });

    document.getElementById("btnRefresh").addEventListener("click", () => window.WINNERLAND.renderNow());
    document.getElementById("btnExportPNGs").addEventListener("click", () => window.WINNERLAND.exportPNGs());
    document.getElementById("memberCount").addEventListener("change", () => window.WINNERLAND.renderNow());
    document.getElementById("filterTicker").addEventListener("input", () => window.WINNERLAND.renderNow());
    document.getElementById("minNZD").addEventListener("input", () => window.WINNERLAND.renderNow());
    document.getElementById("pctMode").addEventListener("change", () => window.WINNERLAND.renderNow());
  </script>
</body>
</html>

